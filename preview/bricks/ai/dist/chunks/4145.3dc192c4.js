"use strict";(globalThis.webpackChunk_next_bricks_ai=globalThis.webpackChunk_next_bricks_ai||[]).push([[4145],{4145:(e,t,s)=>{var n,a=s(4635),i=s(918),o=s(6902),r=s(5536),h=s(6121),l=s(829),c=s(2740),u=s(8769),d=s.n(u),A=s(300),w=s(4295),g=s(15),p=s(2046),v=s(2442),k=s(3830),I=s(205);let y,m,f,S,C,b,M,L,W,E,B,R,T,q,N,x,U,_,P,Q,F,D,H,O,$,J,Z,j,z,G,K,V,X,Y,ee,te,se,ne,ae,ie,oe,re,he,le,ce,ue,de,Ae;s(6477),s(2896),s(3262);const{defineElement:we,property:ge,method:pe,event:ve}=(0,A.createDecorators)();function ke(e,t){let{agentId:s,robotId:n,sessionId:a,showAvatar:i,showSessionList:o=!0,readonly:r=!1,showLike:h=!0,showShare:l=!0,quickAnswerConfig:c,snippetList:A,enterInterval:w,debug:y=!1,useSpiltWord:m=!1,commandBricks:f,answerLanguage:S,inputToolbarBrick:C,showToolCalls:b,onSessionIdChange:M,onRobotIdChange:L,onQaFinish:W}=e;const{sessionEnd:E,sessionLoading:B,activeSessionId:R,msgEnd:T,msgLoading:q,msgList:N,sessionList:x,loading:U,chatting:_,searchStr:P,toolNames:Q,setAgent:F,handleIsLike:D,handleChat:H,stopChat:O,createSession:$,deleteSession:J,updateSession:Z,checkSession:j,setSearchStr:z,querySessionHistory:G}=(0,v.Fn)({agentId:s,robotId:n,sessionId:a,enterInterval:w,debug:y,answerLanguage:S,useSpiltWord:m,showToolCalls:b});return(0,u.useEffect)((()=>{var e;R&&(M(R),L(null===(e=x.find((e=>e.conversationId===R)))||void 0===e?void 0:e.robotId))}),[R,L,M,x]),(0,u.useEffect)((()=>{!_&&R&&W(R)}),[_]),d().createElement(g.t.Provider,{value:{sessionEnd:E,sessionLoading:B,activeSessionId:R,sessionList:x,msgEnd:T,msgLoading:q,msgList:N,chatting:_,loading:U,searchStr:P,showLike:h,showShare:l,readonly:r,quickAnswerConfig:c,snippetList:A,commandBricks:f,showToolCalls:b,toolNames:Q,setAgent:F,handleIsLike:D,handleChat:H,stopChat:O,createSession:$,deleteSession:J,updateSession:Z,checkSession:j,setSearchStr:z,querySessionHistory:G}},d().createElement("div",{className:"chat-view-container"},o&&d().createElement("div",{className:"chat-view-selector"},d().createElement(k.Z,null)),d().createElement("div",{className:"chat-view-content"},d().createElement(p.M,{showAvatar:i}),!r&&d().createElement(I.D,{inputToolbarBrick:C,ref:t}))))}const Ie=(0,u.forwardRef)(ke);let ye;var me=new WeakMap,fe=new WeakMap,Se=new WeakMap,Ce=new WeakMap,be=new WeakMap,Me=new WeakMap,Le=new WeakMap,We=new WeakMap,Ee=new WeakMap,Be=new WeakMap,Re=new WeakMap,Te=new WeakMap,qe=new WeakMap,Ne=new WeakMap,xe=new WeakMap,Ue=new WeakMap,_e=new WeakMap,Pe=new WeakMap,Qe=new WeakMap,Fe=new WeakSet,De=new WeakMap,He=new WeakMap,Oe=new WeakMap,$e=new WeakMap,Je=new WeakMap;class Ze extends w.ReactNextElement{constructor(){super(...arguments),(0,a.A)(this,Fe),(0,i.A)(this,me,(y(this),f(this))),(0,i.A)(this,fe,(S(this),C(this))),(0,i.A)(this,Se,(b(this),M(this))),(0,i.A)(this,Ce,(L(this),W(this))),(0,i.A)(this,be,(E(this),B(this))),(0,i.A)(this,Me,(R(this),T(this))),(0,i.A)(this,Le,(q(this),N(this))),(0,i.A)(this,We,(x(this),U(this))),(0,i.A)(this,Ee,(_(this),P(this))),(0,i.A)(this,Be,(Q(this),F(this))),(0,i.A)(this,Re,(D(this),H(this))),(0,i.A)(this,Te,(O(this),$(this))),(0,i.A)(this,qe,(J(this),Z(this))),(0,i.A)(this,Ne,(j(this),z(this))),(0,i.A)(this,xe,(G(this),K(this))),(0,i.A)(this,Ue,(V(this),X(this))),(0,i.A)(this,_e,(Y(this),ee(this))),(0,i.A)(this,Pe,(te(this),d().createRef())),(0,i.A)(this,Qe,se(this)),(0,i.A)(this,De,(ie(this),e=>{(0,r.A)(Fe,this,ne).emit(e)})),(0,i.A)(this,He,oe(this)),(0,i.A)(this,Oe,(le(this),e=>{(0,r.A)(Fe,this,re).emit(e)})),(0,i.A)(this,$e,ce(this)),(0,i.A)(this,Je,(Ae(this),e=>{(0,r.A)(Fe,this,ue).emit(e)}))}get sessionId(){return(0,l.A)(me,this)}set sessionId(e){(0,h.A)(me,this,e)}get agentId(){return(0,l.A)(fe,this)}set agentId(e){(0,h.A)(fe,this,e)}get robotId(){return(0,l.A)(Se,this)}set robotId(e){(0,h.A)(Se,this,e)}get answerLanguage(){return(0,l.A)(Ce,this)}set answerLanguage(e){(0,h.A)(Ce,this,e)}get debug(){return(0,l.A)(be,this)}set debug(e){(0,h.A)(be,this,e)}get showAvatar(){return(0,l.A)(Me,this)}set showAvatar(e){(0,h.A)(Me,this,e)}get showSessionList(){return(0,l.A)(Le,this)}set showSessionList(e){(0,h.A)(Le,this,e)}get readonly(){return(0,l.A)(We,this)}set readonly(e){(0,h.A)(We,this,e)}get showLike(){return(0,l.A)(Ee,this)}set showLike(e){(0,h.A)(Ee,this,e)}get showShare(){return(0,l.A)(Be,this)}set showShare(e){(0,h.A)(Be,this,e)}get useSpiltWord(){return(0,l.A)(Re,this)}set useSpiltWord(e){(0,h.A)(Re,this,e)}get enterInterval(){return(0,l.A)(Te,this)}set enterInterval(e){(0,h.A)(Te,this,e)}get quickAnswerConfig(){return(0,l.A)(qe,this)}set quickAnswerConfig(e){(0,h.A)(qe,this,e)}get snippetList(){return(0,l.A)(Ne,this)}set snippetList(e){(0,h.A)(Ne,this,e)}get commandBricks(){return(0,l.A)(xe,this)}set commandBricks(e){(0,h.A)(xe,this,e)}get inputToolbarBrick(){return(0,l.A)(Ue,this)}set inputToolbarBrick(e){(0,h.A)(Ue,this,e)}get showToolCalls(){return(0,l.A)(_e,this)}set showToolCalls(e){(0,h.A)(_e,this,e)}insertQuestion(e){var t;const{value:s}=e;s&&(null===(t=(0,l.A)(Pe,this).current)||void 0===t||t.handleInsertQuestion(s))}sendMsg(e){var t;null===(t=(0,l.A)(Pe,this).current)||void 0===t||t.sendMsg(e)}render(){return d().createElement(Ie,{agentId:this.agentId,robotId:this.robotId,debug:this.debug,sessionId:this.sessionId,readonly:this.readonly,showAvatar:this.showAvatar,showSessionList:this.showSessionList,showLike:this.showLike,showShare:this.showShare,useSpiltWord:this.useSpiltWord,quickAnswerConfig:this.quickAnswerConfig,snippetList:this.snippetList,enterInterval:this.enterInterval,commandBricks:this.commandBricks,answerLanguage:this.answerLanguage,inputToolbarBrick:this.inputToolbarBrick,showToolCalls:this.showToolCalls,onSessionIdChange:(0,l.A)(De,this),onRobotIdChange:(0,l.A)(Oe,this),onQaFinish:(0,l.A)(Je,this),ref:(0,l.A)(Pe,this)})}}n=Ze,({e:[f,S,C,b,M,L,W,E,B,R,T,q,N,x,U,_,P,Q,F,D,H,O,$,J,Z,j,z,G,K,V,X,Y,ee,te,se,ne,ae,ie,oe,re,he,le,ce,ue,de,Ae,y],c:[ye,m]}=(0,c.A)(n,[we("ai.chat-view",{shadowOptions:!1})],[[ge(),1,"sessionId"],[ge(),1,"agentId"],[ge(),1,"robotId"],[ge(),1,"answerLanguage"],[ge({type:Boolean}),1,"debug"],[ge({type:Boolean}),1,"showAvatar"],[ge({type:Boolean}),1,"showSessionList"],[ge({type:Boolean}),1,"readonly"],[ge({type:Boolean}),1,"showLike"],[ge({type:Boolean}),1,"showShare"],[ge({type:Boolean}),1,"useSpiltWord"],[ge({type:Number}),1,"enterInterval"],[ge({attribute:!1}),1,"quickAnswerConfig"],[ge({attribute:!1}),1,"snippetList"],[ge({attribute:!1}),1,"commandBricks"],[ge({attribute:!1}),1,"inputToolbarBrick"],[ge({type:Boolean}),1,"showToolCalls"],[ve({type:"sessionId.change"}),1,"sessionIdChange",e=>(0,l.A)(Qe,e),(e,t)=>(0,h.A)(Qe,e,t)],[ve({type:"robotId.change"}),1,"robotIdChange",e=>(0,l.A)(He,e),(e,t)=>(0,h.A)(He,e,t)],[ve({type:"qa.finish"}),1,"qaFinish",e=>(0,l.A)($e,e),(e,t)=>(0,h.A)($e,e,t)],[pe(),2,"insertQuestion"],[pe(),2,"sendMsg"]],0,(e=>Je.has((0,o.A)(e))),w.ReactNextElement)),m();var je,ze=s(5223),Ge=s(3078),Ke=s(356);let Ve,Xe,Ye,et,tt,st,nt,at,it,ot,rt,ht,lt,ct,ut,dt,At,wt,gt,pt,vt,kt;const{defineElement:It,property:yt,event:mt,method:ft}=(0,A.createDecorators)(),St=(0,u.forwardRef)(Pt);let Ct;var bt=new WeakMap,Mt=new WeakMap,Lt=new WeakMap,Wt=new WeakMap,Et=new WeakMap,Bt=new WeakSet,Rt=new WeakMap,Tt=new WeakMap,qt=new WeakMap,Nt=new WeakMap,xt=new WeakMap,Ut=new WeakMap;class _t extends w.ReactNextElement{constructor(){super(...arguments),(0,a.A)(this,Bt),(0,i.A)(this,bt,(Ve(this),Ye(this))),(0,i.A)(this,Mt,(et(this),tt(this))),(0,i.A)(this,Lt,(st(this),nt(this))),(0,i.A)(this,Wt,(at(this),it(this))),(0,i.A)(this,Et,(ot(this),rt(this))),(0,i.A)(this,Rt,(ct(this),e=>{(0,r.A)(Bt,this,ht).emit(e)})),(0,i.A)(this,Tt,ut(this)),(0,i.A)(this,qt,(wt(this),e=>{(0,r.A)(Bt,this,dt).emit(e)})),(0,i.A)(this,Nt,gt(this)),(0,i.A)(this,xt,(kt(this),e=>{(0,r.A)(Bt,this,pt).emit(e)})),(0,i.A)(this,Ut,(0,u.createRef)())}get agentId(){return(0,l.A)(bt,this)}set agentId(e){(0,h.A)(bt,this,e)}get robotId(){return(0,l.A)(Mt,this)}set robotId(e){(0,h.A)(Mt,this,e)}get conversationId(){return(0,l.A)(Lt,this)}set conversationId(e){(0,h.A)(Lt,this,e)}get alwaysUseNewConversation(){return(0,l.A)(Wt,this)}set alwaysUseNewConversation(e){(0,h.A)(Wt,this,e)}postMessage(e){var t;return null===(t=(0,l.A)(Ut,this).current)||void 0===t?void 0:t.postMessage(e)}sendRequest(e,t,s){var n;return null===(n=(0,l.A)(Ut,this).current)||void 0===n?void 0:n.sendRequest(e,t,s)}lowLevelSendRequest(e,t,s){var n;return null===(n=(0,l.A)(Ut,this).current)||void 0===n?void 0:n.lowLevelSendRequest(e,t,s)}newConversation(){var e;null===(e=(0,l.A)(Ut,this).current)||void 0===e||e.newConversation()}render(){return d().createElement(St,{ref:(0,l.A)(Ut,this),agentId:this.agentId,robotId:this.robotId,conversationId:this.conversationId,alwaysUseNewConversation:this.alwaysUseNewConversation,onMessagesUpdate:(0,l.A)(Rt,this),onBusyChange:(0,l.A)(qt,this),onConversationIdChange:(0,l.A)(xt,this)})}}function Pt(e,t){let{agentId:s,robotId:n,conversationId:a,alwaysUseNewConversation:i,onMessageChunkPush:o,onMessagesUpdate:r,onBusyChange:h,onConversationIdChange:l}=e;const c=(0,u.useRef)(!1),d=(0,u.useRef)(1),A=(0,u.useRef)(!1),[w,g]=(0,u.useState)(null);(0,u.useEffect)((()=>{g(a??null)}),[a]),(0,u.useEffect)((()=>{c.current&&(null==l||l(w))}),[w,l]);const p=(0,u.useRef)(0),v=(0,u.useCallback)((()=>p.current++),[]),[k,I]=(0,u.useState)([]),y=(0,u.useCallback)((e=>{null==o||o(e),I((t=>{const s=t[t.length-1];return s&&s.key===e.key?(s.content+=e.delta.content,[...t]):(null!=s&&s.partial&&(s.partial=!1),[...t,{...e.delta,key:e.key,partial:e.partial}])}))}),[o]),m=(0,u.useCallback)((async(e,t,s,n)=>{if(A.current)return null;(i||e)&&I((e=>0===e.length?e:[]));const a=d.current;let o;const r=async()=>{if(a!==d.current)throw o||(o=new Error("New conversation started")),o},l=v(),c=v();let u=i||e?null:w;null==h||h(A.current=!0);try{if(Array.isArray(t))for(const e of t){const t="assistant"===e.role;(t||"user"===e.role)&&(null==y||y({key:t?c:l,delta:{role:e.role,content:e.content}}))}else null==y||y({key:l,delta:{content:t,role:"user"}});const a=(0,Ge.createSSEStream)(new URL(s,`${location.origin}${(0,ze.getBasePath)()}`).toString(),n);await Promise.race([a,new Promise((e=>setTimeout(e,1e3)))]),await r(),null==y||y({key:c,delta:{content:"",role:"assistant"},partial:!0});const o=await a;for await(const t of o)if(await r(),e){var p;const e=null===(p=t.choices)||void 0===p||null===(p=p[0])||void 0===p?void 0:p.delta;null!=e&&e.content&&y({delta:{role:e.role,content:e.content},key:c,partial:!0})}else null==y||y({delta:t.delta,key:c,partial:!0}),i||!t.conversationId||u||g(u=t.conversationId);await r(),I((e=>{const t=e[e.length-1];return null!=t&&t.partial&&(t.partial=!1),[...e]}))}catch(e){if(e&&e===o)throw e;console.error("stream failed:",e),await r(),I((e=>{const t=e[e.length-1];let s=e;return(null==t?void 0:t.key)===c&&(t.content?(t.partial=!1,t.failed=!0):s=e.slice(0,-1)),[...s,{role:"assistant",content:"系统错误",key:v(),failed:!0}]}))}return await r(),null==h||h(A.current=!1),u}),[w,i,v,h,y]);return(0,u.useImperativeHandle)(t,(()=>({lowLevelSendRequest:function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return m(!0,...t)},sendRequest:function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];return m(!1,...t)},postMessage:e=>m(!1,e,"api/gateway/easyops.api.aiops_chat.manage.LLMChatProxy@1.0.0/api/aiops_chat/v1/chat/completions",{method:"POST",body:JSON.stringify({agentId:s,robotId:n,input:e,stream:!0,conversationId:i||null===w?void 0:w}),headers:{"giraffe-contract-name":"easyops.api.aiops_chat.manage.LLMChatProxy"}}),newConversation(){d.current++,g(null),I((e=>0===e.length?e:[])),A.current&&(null==h||h(A.current=!1))}})),[m,s,n,i,w,h]),(0,u.useEffect)((()=>{c.current&&(null==r||r(k))}),[k,r]),(0,u.useEffect)((()=>{c.current=!0}),[]),null}je=_t,({e:[Ye,et,tt,st,nt,at,it,ot,rt,ht,lt,ct,ut,dt,At,wt,gt,pt,vt,kt,Ve],c:[Ct,Xe]}=(0,c.A)(je,[It("ai.chat-agent",{styleTexts:[Ke.A]})],[[yt(),1,"agentId"],[yt(),1,"robotId"],[yt(),1,"conversationId"],[yt(),1,"alwaysUseNewConversation"],[ft(),2,"postMessage"],[ft(),2,"sendRequest"],[ft(),2,"lowLevelSendRequest"],[ft(),2,"newConversation"],[mt({type:"messages.update"}),1,"messagesUpdate",e=>(0,l.A)(Et,e),(e,t)=>(0,h.A)(Et,e,t)],[mt({type:"busy.change"}),1,"busyChangeEvent",e=>(0,l.A)(Tt,e),(e,t)=>(0,h.A)(Tt,e,t)],[mt({type:"conversationId.change"}),1,"conversationIdChangeEvent",e=>(0,l.A)(Nt,e),(e,t)=>(0,h.A)(Nt,e,t)]],0,(e=>Ut.has((0,o.A)(e))),w.ReactNextElement)),Xe()},356:(e,t,s)=>{s.d(t,{A:()=>r});var n=s(6758),a=s.n(n),i=s(935),o=s.n(i)()(a());o.push([e.id,":host{display:none}",""]);const r=o.toString()}}]);
//# sourceMappingURL=4145.3dc192c4.js.map