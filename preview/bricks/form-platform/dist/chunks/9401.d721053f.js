"use strict";(self.webpackChunk_next_bricks_form_platform=self.webpackChunk_next_bricks_form_platform||[]).push([[9401],{9401:(e,t,i)=>{i.r(t);var r,s,a,l,u,n,o,d,c,h,p,v,Z,U,y,m,b,g,f,k,M,w,E,G,R,S,_,W,q,L,Q,A,j,O,$,B,P,C,z,x,I=i(3028),N=i(4795),F=i(6666),D=i(3395),H=i(1815),T=i(381),V=i(687),J=i(2604),K=i(8657),X=i.n(K),Y=i(5366),ee=i(4511),te=i(3622),ie=i(7759),re=(i(8161),i(7124)),se=i(5576),ae=i(2021),le=i(1969),ue=i(1211),{defineElement:ne,property:oe,event:de}=(0,Y.createDecorators)(),ce=(0,ee.wrapBrick)("eo-form-item"),he=(0,ee.wrapBrick)("eo-button"),pe=(0,ee.wrapBrick)("eo-select");s=ne("eo-user-or-user-group-select",{styleTexts:[re.Z]}),a=oe(),u=oe(),o=oe({type:Boolean}),c=oe(),p=oe({attribute:!1}),Z=oe({attribute:!1}),y=oe({attribute:!1}),b=oe({attribute:!1}),f=oe({attribute:!1}),M=oe(),E=oe({type:Boolean}),R=oe({type:Boolean}),_=oe({type:Boolean}),q=oe({attribute:!1}),Q=oe({type:Boolean}),j=de({type:"change"});var ve=new WeakMap,Ze=new WeakMap,Ue=new WeakMap,ye=new WeakMap,me=new WeakMap,be=new WeakMap,ge=new WeakMap,fe=new WeakMap,ke=new WeakMap,Me=new WeakMap,we=new WeakMap,Ee=new WeakMap,Ge=new WeakMap,Re=new WeakMap,Se=new WeakMap,_e=new WeakMap,We=new WeakMap,qe=new WeakMap;class Le extends se.G{constructor(){super(...arguments),(0,D.Z)(this,We,{get:Ae,set:Qe}),(0,D.Z)(this,ve,{writable:!0,value:(P(this),l(this))}),(0,D.Z)(this,Ze,{writable:!0,value:n(this)}),(0,D.Z)(this,Ue,{writable:!0,value:d(this)}),(0,D.Z)(this,ye,{writable:!0,value:h(this)}),(0,D.Z)(this,me,{writable:!0,value:v(this)}),(0,D.Z)(this,be,{writable:!0,value:U(this)}),(0,D.Z)(this,ge,{writable:!0,value:m(this)}),(0,D.Z)(this,fe,{writable:!0,value:g(this)}),(0,D.Z)(this,ke,{writable:!0,value:k(this)}),(0,D.Z)(this,Me,{writable:!0,value:w(this,"all")}),(0,D.Z)(this,we,{writable:!0,value:G(this,!1)}),(0,D.Z)(this,Ee,{writable:!0,value:S(this)}),(0,D.Z)(this,Ge,{writable:!0,value:W(this,!0)}),(0,D.Z)(this,Re,{writable:!0,value:L(this)}),(0,D.Z)(this,Se,{writable:!0,value:A(this,!0)}),(0,D.Z)(this,_e,{writable:!0,value:O(this)}),(0,D.Z)(this,qe,{writable:!0,value:void 0}),(0,F.Z)(this,"handleUserOrUserGroupChange",(e=>{var t={selectedUser:(0,ue.reject)(e,(e=>(0,ue.startsWith)(e,":"))),selectedUserGroup:(0,ue.filter)(e,(e=>(0,ue.startsWith)(e,":")))};this.value=t,(0,T.Z)(this,qe,t),Promise.resolve().then((()=>{var i;(0,V.Z)(this,We).emit(this.mergeUseAndUserGroup?e:t),null===(i=this.getFormElement())||void 0===i||i.resetValidateState()}))})),(0,F.Z)(this,"_handleMergeUseAndUserGroup",(e=>(0,ue.groupBy)(e,(e=>(0,ue.startsWith)(e,":")?"selectedUserGroup":"selectedUser"))))}get name(){return(0,V.Z)(this,ve)}set name(e){(0,T.Z)(this,ve,e)}get label(){return(0,V.Z)(this,Ze)}set label(e){(0,T.Z)(this,Ze,e)}get required(){return(0,V.Z)(this,Ue)}set required(e){(0,T.Z)(this,Ue,e)}get placeholder(){return(0,V.Z)(this,ye)}set placeholder(e){(0,T.Z)(this,ye,e)}get value(){return(0,V.Z)(this,me)}set value(e){(0,T.Z)(this,me,e)}get objectList(){return(0,V.Z)(this,be)}set objectList(e){(0,T.Z)(this,be,e)}get query(){return(0,V.Z)(this,ge)}set query(e){(0,T.Z)(this,ge,e)}get userQuery(){return(0,V.Z)(this,fe)}set userQuery(e){(0,T.Z)(this,fe,e)}get userGroupQuery(){return(0,V.Z)(this,ke)}set userGroupQuery(e){(0,T.Z)(this,ke,e)}get optionsMode(){return(0,V.Z)(this,Me)}set optionsMode(e){(0,T.Z)(this,Me,e)}get mergeUseAndUserGroup(){return(0,V.Z)(this,we)}set mergeUseAndUserGroup(e){(0,T.Z)(this,we,e)}get disabled(){return(0,V.Z)(this,Ee)}set disabled(e){(0,T.Z)(this,Ee,e)}get isMultiple(){return(0,V.Z)(this,Ge)}set isMultiple(e){(0,T.Z)(this,Ge,e)}get staticList(){return(0,V.Z)(this,Re)}set staticList(e){(0,T.Z)(this,Re,e)}get hideAddMeQuickly(){return(0,V.Z)(this,Se)}set hideAddMeQuickly(e){(0,T.Z)(this,Se,e)}connectedCallback(){(0,T.Z)(this,qe,this.value),this.mergeUseAndUserGroup&&this.value&&(0,T.Z)(this,qe,this._handleMergeUseAndUserGroup(this.value)),super.connectedCallback()}render(){return X().createElement(je,{formElement:this.getFormElement(),curElement:this,name:this.name,label:this.label,placeholder:this.placeholder,required:this.required,value:(0,V.Z)(this,qe),validateState:this.validateState,notRender:this.notRender,helpBrick:this.helpBrick,trigger:"handleUserOrUserGroupChange",onChange:this.handleUserOrUserGroupChange,objectList:this.objectList,query:this.query,userQuery:this.userQuery,userGroupQuery:this.userGroupQuery,optionsMode:this.optionsMode,staticList:this.staticList,isMultiple:this.isMultiple,disabled:this.disabled,hideAddMeQuickly:this.hideAddMeQuickly})}}function Qe(e){B(this,e)}function Ae(){return $(this)}function je(e){var t,[i,r]=(0,K.useState)(null!==(t=e.objectList)&&void 0!==t?t:[]),[s,a]=(0,K.useState)(),[l,u]=(0,K.useState)([]),[n,o]=(0,K.useState)([]),[d,c]=(0,K.useState)([]),h=(0,K.useRef)([]),p=(0,K.useMemo)((()=>{var t,i,r,s;if(!(0,ue.isNil)(e.value))return e.isMultiple?[...(null===(t=e.value)||void 0===t?void 0:t.selectedUser)||[],...(null===(i=e.value)||void 0===i?void 0:i.selectedUserGroup)||[]]:(null===(r=e.value)||void 0===r||null===(r=r.selectedUser)||void 0===r?void 0:r[0])||(null===(s=e.value)||void 0===s||null===(s=s.selectedUserGroup)||void 0===s?void 0:s[0])}),[e.value,e.isMultiple]),v=(0,K.useCallback)((e=>{var t,r,s=(0,ue.keyBy)(i,"objectId");return(null===(t=s[e])||void 0===t?void 0:t.view)&&(null===(r=s[e].view)||void 0===r?void 0:r.show_key)||["name"]}),[i]),Z=function(){var t=(0,N.Z)((function*(t,i){var r,s,a=v("USER"===t?"USER":"USER_GROUP"),l=(0,I.Z)({$or:(0,ue.map)((0,ue.uniq)([...a,"name"]),(e=>({[e]:{$like:"%".concat(i,"%")}})))},"USER"===t?{state:"valid"}:{}),u="USER"===t?{name:{$in:null===(r=e.value)||void 0===r?void 0:r.selectedUser}}:{instanceId:{$in:(0,ue.map)(null===(s=e.value)||void 0===s?void 0:s.selectedUserGroup,(e=>e.slice(1)))}};return(yield(0,ae.x)(t,{page:1,page_size:20,fields:(0,I.Z)((0,I.Z)({},(0,ue.zipObject)(a,(0,ue.map)(a,(e=>!0)))),{},{name:!0}),query:e.userQuery&&"USER"===t?{$and:[e.userQuery,l],$or:u}:e.userGroupQuery&&"USER_GROUP"===t?{$and:[e.userGroupQuery,l],$or:u}:e.query?{$and:[e.query,l],$or:u}:{$or:[l,u]}})).list}));return function(e,i){return t.apply(this,arguments)}}(),U=function(){var e=(0,N.Z)((function*(e){u((yield Z("USER",e))||[])}));return function(t){return e.apply(this,arguments)}}(),y=function(){var e=(0,N.Z)((function*(e){var t=yield Z("USER_GROUP",e);o((null==t?void 0:t.map((e=>(e.instanceId=":"+e.instanceId,e))))||[])}));return function(t){return e.apply(this,arguments)}}(),m=function(){var t=(0,N.Z)((function*(t){a(t),yield Promise.all([..."group"!==e.optionsMode?[U(t)]:[],..."user"!==e.optionsMode?[y(t)]:[]])}));return function(e){return t.apply(this,arguments)}}(),b=t=>{var i;null===(i=e.onChange)||void 0===i||i.call(e,t)},g=t=>{var i,r=null===(i=t.detail)||void 0===i?void 0:i.value,a=(0,ue.filter)(Array.isArray(r)?r:r?[r]:[],(t=>!(0,ue.find)(e.staticList,(e=>e===t))));a.unshift(...h.current),c(a),b(a),""!==s&&m("")};(0,K.useEffect)((()=>{(0,N.Z)((function*(){if(e.objectList)r(e.objectList);else if(z)r(z);else try{var t=(yield(0,le.G)({ref_object:"USER,USER_GROUP"})).data;r(t),z=t}catch(e){(0,te.handleHttpError)(e)}}))()}),[e.objectList,e.notRender]);var f=(e,t)=>{var i=v("USER"===e?"USER":"USER_GROUP");return(Array.isArray(i)?i.map(((e,i)=>0===i?t[e]:t[e]?"("+t[e]+")":"")).join(""):t[i])||t.name};(0,K.useEffect)((()=>{var t,i,r,s,a,l,n=function(){var t=(0,N.Z)((function*(){if(e.value){var t,i=[],r=[],s=(0,ue.groupBy)(e.staticList,(e=>(0,ue.startsWith)(e,":")?"userGroup":"user")),a=(0,ue.compact)((0,ue.uniq)([].concat(s.user).concat(null===(t=e.value)||void 0===t?void 0:t.selectedUser))),l=(0,ue.compact)((0,ue.uniq)([].concat(s.userGroup).concat(e.value.selectedUserGroup)));(s.user&&(0,ue.some)(s.user,(t=>{var i;return!(null!==(i=e.value)&&void 0!==i&&null!==(i=i.selectedUser)&&void 0!==i&&i.includes(t))}))||s.userGroup&&(0,ue.some)(s.userGroup,(t=>{var i;return!(null!==(i=e.value)&&void 0!==i&&null!==(i=i.selectedUserGroup)&&void 0!==i&&i.includes(t))})))&&b({selectedUser:a,selectedUserGroup:l});var n=[];a.length&&"group"!==e.optionsMode&&(i=(yield(0,ae.x)("USER",{query:{name:{$in:a}},page:1,page_size:a.length,fields:(0,I.Z)((0,I.Z)({},(0,ue.zipObject)(v("USER"),(0,ue.map)(v("USER"),(e=>!0)))),{},{name:!0})})).list),l.length&&"user"!==e.optionsMode&&(r=(yield(0,ae.x)("USER_GROUP",{query:{instanceId:{$in:(0,ue.map)(l,(e=>e.slice(1)))}},page:1,page_size:l.length,fields:(0,I.Z)((0,I.Z)({},(0,ue.zipObject)(v("USER_GROUP"),(0,ue.map)(v("USER_GROUP"),(e=>!0)))),{},{name:!0})})).list);var d=[...(0,ue.map)(i,(t=>{var i,r=f("USER",t),s={key:t.name,label:r};return null!==(i=e.staticList)&&void 0!==i&&i.includes(t.name)&&n.push(s),s})),...(0,ue.map)(r,(t=>{var i,r=f("USER_GROUP",t),s={key:":"+t.instanceId,label:r};return null!==(i=e.staticList)&&void 0!==i&&i.includes(":"+t.instanceId)&&n.push(s),s}))];d=[...n,...(0,ue.filter)(d,(t=>{var i;return!(null!==(i=e.staticList)&&void 0!==i&&i.includes(t.key))}))],c(d),u(i),o(r),h.current=n}}));return function(){return t.apply(this,arguments)}}();r=(null===(t=e.value)||void 0===t?void 0:t.selectedUser)||[],s=(null===(i=e.value)||void 0===i?void 0:i.selectedUserGroup)||[],a=(0,ue.map)((0,ue.filter)(d,(e=>{var t;return!(null!=e&&null!==(t=e.key)&&void 0!==t&&t.startsWith(":"))})),"key"),l=(0,ue.map)((0,ue.filter)(d,(e=>{var t;return null==e||null===(t=e.key)||void 0===t?void 0:t.startsWith(":")})),"key"),(0,ue.isEqual)([...r].sort(),[...a].sort())&&(0,ue.isEqual)([...s].sort(),[...l].sort())||n()}),[]);var k=(0,K.useMemo)((()=>{var t=[],i=[];return l.length&&(t=[{label:"用户(仅显示前20项，更多结果请搜索)",options:l.map((t=>{var i;return{label:f("USER",t),value:t.name,closeable:!(null!=e&&null!==(i=e.staticList)&&void 0!==i&&i.includes(t.name))}}))}]),n.length&&(i=[{label:"用户组(仅显示前20项，更多结果请搜索",options:n.map((t=>{var i;return{label:f("USER_GROUP",t),value:t.instanceId,closeable:!(null!=e&&null!==(i=e.staticList)&&void 0!==i&&i.includes(t.instanceId))}}))}]),"user"===e.optionsMode?t:"group"===e.optionsMode?i:[...t,...i]}),[l,n,e.optionsMode,e.staticList]),M=function(){var e=(0,N.Z)((function*(){var e=ie.auth.getAuth().username;if(!(0,ue.find)(d,(t=>t===e))){var t=(yield(0,ae.x)("USER",{query:{name:{$eq:e}},page:1,page_size:1,fields:(0,I.Z)((0,I.Z)({},(0,ue.zipObject)(v("USER"),(0,ue.map)(v("USER"),(e=>!0)))),{},{name:!0})})).list;t.length&&u([...l,...t]),g({detail:{value:[...d,e]}})}}));return function(){return e.apply(this,arguments)}}();return X().createElement(ce,e,X().createElement("div",{className:"select-wrapper"},X().createElement(pe,{clearable:!0,mode:e.isMultiple?"multiple":void 0,placeholder:e.placeholder,value:p,onchange:g,onfocus:()=>{((0,ue.isNil)(s)||""!==s)&&m("")},onsearch:(0,ue.debounce)((e=>{m(e.detail.value)}),500),options:k,disabled:e.disabled}),!e.hideAddMeQuickly&&"group"!==e.optionsMode&&X().createElement(he,{onClick:M,type:"link",size:"large",style:{fontSize:"16px"},icon:{lib:"easyops",icon:"quick-add-me"}})))}C=Le,({e:[l,n,d,h,v,U,m,g,k,w,G,S,W,L,A,O,$,B,P],c:[x,r]}=(0,J.Z)(C,[[a,1,"name"],[u,1,"label"],[o,1,"required"],[c,1,"placeholder"],[p,1,"value"],[Z,1,"objectList"],[y,1,"query"],[b,1,"userQuery"],[f,1,"userGroupQuery"],[M,1,"optionsMode"],[E,1,"mergeUseAndUserGroup"],[R,1,"disabled"],[_,1,"isMultiple"],[q,1,"staticList"],[Q,1,"hideAddMeQuickly"],[j,1,"changeEvent",e=>(0,V.Z)(e,_e),(e,t)=>(0,T.Z)(e,_e,t)]],[s],0,(e=>qe.has((0,H.Z)(e))),se.G)),r()}}]);
//# sourceMappingURL=9401.d721053f.js.map