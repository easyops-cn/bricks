"use strict";(globalThis.webpackChunk_next_bricks_basic=globalThis.webpackChunk_next_bricks_basic||[]).push([[747],{747:(e,n,t)=>{t.r(n),t.d(n,{BroadcastChannel:()=>D,OPEN_BROADCAST_CHANNELS:()=>x,beLeader:()=>q,clearNodeFolder:()=>N,createLeaderElection:()=>V,enforceOptions:()=>O});var r=Promise.resolve(!1),o=Promise.resolve(!0),i=Promise.resolve();function s(e,n){return e||(e=0),new Promise((function(t){return setTimeout((function(){return t(n)}),e)}))}function a(){return Math.random().toString(36).substring(2)}var u=0;function c(){var e=1e3*Date.now();return e<=u&&(e=u+1),u=e,e}var l={create:function(e){var n={time:c(),messagesCallback:null,bc:new BroadcastChannel(e),subFns:[]};return n.bc.onmessage=function(e){n.messagesCallback&&n.messagesCallback(e.data)},n},close:function(e){e.bc.close(),e.subFns=[]},onMessage:function(e,n){e.messagesCallback=n},postMessage:function(e,n){try{return e.bc.postMessage(n,!1),i}catch(e){return Promise.reject(e)}},canBeUsed:function(){if("undefined"!=typeof globalThis&&globalThis.Deno&&globalThis.Deno.args)return!0;if("undefined"==typeof window&&"undefined"==typeof self||"function"!=typeof BroadcastChannel)return!1;if(BroadcastChannel._pubkey)throw new Error("BroadcastChannel: Do not overwrite window.BroadcastChannel with this module, this is not a polyfill");return!0},type:"native",averageResponseTime:function(){return 150},microSeconds:c};class d{ttl;map=new Map;_to=!1;constructor(e){this.ttl=e}has(e){return this.map.has(e)}add(e){this.map.set(e,f()),this._to||(this._to=!0,setTimeout((()=>{this._to=!1,function(e){const n=f()-e.ttl,t=e.map[Symbol.iterator]();for(;;){const r=t.next().value;if(!r)return;const o=r[0];if(!(r[1]<n))return;e.map.delete(o)}}(this)}),0))}clear(){this.map.clear()}}function f(){return Date.now()}function h(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=JSON.parse(JSON.stringify(e));return void 0===n.webWorkerSupport&&(n.webWorkerSupport=!0),n.idb||(n.idb={}),n.idb.ttl||(n.idb.ttl=45e3),n.idb.fallbackInterval||(n.idb.fallbackInterval=150),e.idb&&"function"==typeof e.idb.onclose&&(n.idb.onclose=e.idb.onclose),n.localstorage||(n.localstorage={}),n.localstorage.removeTimeout||(n.localstorage.removeTimeout=6e4),e.methods&&(n.methods=e.methods),n.node||(n.node={}),n.node.ttl||(n.node.ttl=12e4),n.node.maxParallelWrites||(n.node.maxParallelWrites=2048),void 0===n.node.useFastPath&&(n.node.useFastPath=!0),n}var p="messages",m={durability:"relaxed"};function v(){if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof window){if(void 0!==window.mozIndexedDB)return window.mozIndexedDB;if(void 0!==window.webkitIndexedDB)return window.webkitIndexedDB;if(void 0!==window.msIndexedDB)return window.msIndexedDB}return!1}function _(e){e.commit&&e.commit()}function b(e){e.closed||w(e).then((function(){return s(e.options.idb.fallbackInterval)})).then((function(){return b(e)}))}function w(e){return e.closed?i:e.messagesCallback?function(e,n){var t=e.transaction(p,"readonly",m),r=t.objectStore(p),o=[],i=IDBKeyRange.bound(n+1,1/0);if(r.getAll){var s=r.getAll(i);return new Promise((function(e,n){s.onerror=function(e){return n(e)},s.onsuccess=function(n){e(n.target.result)}}))}return new Promise((function(e,s){var a=function(){try{return i=IDBKeyRange.bound(n+1,1/0),r.openCursor(i)}catch(e){return r.openCursor()}}();a.onerror=function(e){return s(e)},a.onsuccess=function(r){var i=r.target.result;i?i.value.id<n+1?i.continue(n+1):(o.push(i.value),i.continue()):(_(t),e(o))}}))}(e.db,e.lastCursorId).then((function(n){var t=n.filter((function(e){return!!e})).map((function(n){return n.id>e.lastCursorId&&(e.lastCursorId=n.id),n})).filter((function(n){return function(e,n){return!(e.uuid===n.uuid||n.eMIs.has(e.id)||e.data.time<n.messagesCallbackTime)}(n,e)})).sort((function(e,n){return e.time-n.time}));return t.forEach((function(n){e.messagesCallback&&(e.eMIs.add(n.id),e.messagesCallback(n.data))})),i})):i}var g={create:function(e,n){return n=h(n),function(e){var n="pubkey.broadcast-channel-0-"+e,t=v().open(n);return t.onupgradeneeded=function(e){e.target.result.createObjectStore(p,{keyPath:"id",autoIncrement:!0})},new Promise((function(e,n){t.onerror=function(e){return n(e)},t.onsuccess=function(){e(t.result)}}))}(e).then((function(t){var r={closed:!1,lastCursorId:0,channelName:e,options:n,uuid:a(),eMIs:new d(2*n.idb.ttl),writeBlockPromise:i,messagesCallback:null,readQueuePromises:[],db:t};return t.onclose=function(){r.closed=!0,n.idb.onclose&&n.idb.onclose()},b(r),r}))},close:function(e){e.closed=!0,e.db.close()},onMessage:function(e,n,t){e.messagesCallbackTime=t,e.messagesCallback=n,w(e)},postMessage:function(e,n){return e.writeBlockPromise=e.writeBlockPromise.then((function(){return function(e,n,t){var r={uuid:n,time:Date.now(),data:t},o=e.transaction([p],"readwrite",m);return new Promise((function(e,n){o.oncomplete=function(){return e()},o.onerror=function(e){return n(e)},o.objectStore(p).add(r),_(o)}))}(e.db,e.uuid,n)})).then((function(){0===(0,10,Math.floor(11*Math.random()+0))&&function(e){return(n=e.db,t=e.options.idb.ttl,r=Date.now()-t,o=n.transaction(p,"readonly",m),i=o.objectStore(p),s=[],new Promise((function(e){i.openCursor().onsuccess=function(n){var t=n.target.result;if(t){var i=t.value;i.time<r?(s.push(i),t.continue()):(_(o),e(s))}else e(s)}}))).then((function(n){return function(e,n){if(e.closed)return Promise.resolve([]);var t=e.db.transaction(p,"readwrite",m).objectStore(p);return Promise.all(n.map((function(e){var n=t.delete(e);return new Promise((function(e){n.onsuccess=function(){return e()}}))})))}(e,n.map((function(e){return e.id})))}));var n,t,r,o,i,s}(e)})),e.writeBlockPromise},canBeUsed:function(){return!!v()},type:"idb",averageResponseTime:function(e){return 2*e.idb.fallbackInterval},microSeconds:c};function L(){var e;if("undefined"==typeof window)return null;try{e=window.localStorage,e=window["ie8-eventlistener/storage"]||window.localStorage}catch(e){}return e}function C(e){return"pubkey.broadcastChannel-"+e}function y(){var e=L();if(!e)return!1;try{var n="__broadcastchannel_check";e.setItem(n,"works"),e.removeItem(n)}catch(e){return!1}return!0}var k={create:function(e,n){if(n=h(n),!y())throw new Error("BroadcastChannel: localstorage cannot be used");var t=a(),r=new d(n.localstorage.removeTimeout),o={channelName:e,uuid:t,eMIs:r};return o.listener=function(e,n){var i=C(e),s=function(e){var n;e.key===i&&(n=JSON.parse(e.newValue),o.messagesCallback&&n.uuid!==t&&n.token&&!r.has(n.token)&&(n.data.time&&n.data.time<o.messagesCallbackTime||(r.add(n.token),o.messagesCallback(n.data))))};return window.addEventListener("storage",s),s}(e),o},close:function(e){var n;n=e.listener,window.removeEventListener("storage",n)},onMessage:function(e,n,t){e.messagesCallbackTime=t,e.messagesCallback=n},postMessage:function(e,n){return new Promise((function(t){s().then((function(){var r=C(e.channelName),o={token:a(),time:Date.now(),data:n,uuid:e.uuid},i=JSON.stringify(o);L().setItem(r,i);var s=document.createEvent("Event");s.initEvent("storage",!0,!0),s.key=r,s.newValue=i,window.dispatchEvent(s),t()}))}))},canBeUsed:y,type:"localstorage",averageResponseTime:function(){var e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")?240:120},microSeconds:c},P=c,E=new Set,M={create:function(e){var n={time:P(),name:e,messagesCallback:null};return E.add(n),n},close:function(e){E.delete(e)},onMessage:function(e,n){e.messagesCallback=n},postMessage:function(e,n){return new Promise((function(t){return setTimeout((function(){Array.from(E).forEach((function(t){t.name===e.name&&t!==e&&t.messagesCallback&&t.time<n.time&&t.messagesCallback(n)})),t()}),5)}))},canBeUsed:function(){return!0},type:"simulate",averageResponseTime:function(){return 5},microSeconds:P},S=[l,g,k];function I(e){var n=[].concat(e.methods,S).filter(Boolean);if(e.type){if("simulate"===e.type)return M;var t=n.find((function(n){return n.type===e.type}));if(t)return t;throw new Error("method-type "+e.type+" not found")}e.webWorkerSupport||(n=n.filter((function(e){return"idb"!==e.type})));var r=n.find((function(e){return e.canBeUsed()}));if(r)return r;throw new Error("No usable method found in "+JSON.stringify(S.map((function(e){return e.type}))))}var B,x=new Set,T=0,D=function(e,n){var t,r,o;this.id=T++,x.add(this),this.name=e,B&&(n=B),this.options=h(n),this.method=I(this.options),this._iL=!1,this._onML=null,this._addEL={message:[],internal:[]},this._uMP=new Set,this._befC=[],this._prepP=null,(o=r=(t=this).method.create(t.name,t.options))&&"function"==typeof o.then?(t._prepP=r,r.then((function(e){t._state=e}))):t._state=r};function N(e){var n=I(e=h(e));return"node"===n.type?n.clearNodeFolder().then((function(){return!0})):r}function O(e){B=e}function K(e,n,t){var r={time:e.method.microSeconds(),type:n,data:t};return(e._prepP?e._prepP:i).then((function(){var n=e.method.postMessage(e._state,r);return e._uMP.add(n),n.catch().then((function(){return e._uMP.delete(n)})),n}))}function Q(e){return e._addEL.message.length>0||e._addEL.internal.length>0}function j(e,n,t){e._addEL[n].push(t),function(e){if(!e._iL&&Q(e)){var n=function(n){e._addEL[n.type].forEach((function(e){n.time>=e.time&&e.fn(n.data)}))},t=e.method.microSeconds();e._prepP?e._prepP.then((function(){e._iL=!0,e.method.onMessage(e._state,n,t)})):(e._iL=!0,e.method.onMessage(e._state,n,t))}}(e)}function A(e,n,t){e._addEL[n]=e._addEL[n].filter((function(e){return e!==t})),function(e){if(e._iL&&!Q(e)){e._iL=!1;var n=e.method.microSeconds();e.method.onMessage(e._state,null,n)}}(e)}D._pubkey=!0,D.prototype={postMessage:function(e){if(this.closed)throw new Error("BroadcastChannel.postMessage(): Cannot post message after channel has closed "+JSON.stringify(e));return K(this,"message",e)},postInternal:function(e){return K(this,"internal",e)},set onmessage(e){var n={time:this.method.microSeconds(),fn:e};A(this,"message",this._onML),e&&"function"==typeof e?(this._onML=n,j(this,"message",n)):this._onML=null},addEventListener:function(e,n){j(this,e,{time:this.method.microSeconds(),fn:n})},removeEventListener:function(e,n){A(this,e,this._addEL[e].find((function(e){return e.fn===n})))},close:function(){var e=this;if(!this.closed){x.delete(this),this.closed=!0;var n=this._prepP?this._prepP:i;return this._onML=null,this._addEL.message=[],n.then((function(){return Promise.all(Array.from(e._uMP))})).then((function(){return Promise.all(e._befC.map((function(e){return e()})))})).then((function(){return e.method.close(e._state)}))}},get type(){return this.method.type},get isClosed(){return this.closed}};var J="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)?function(e){process.on("exit",(function(){return e()})),process.on("beforeExit",(function(){return e().then((function(){return process.exit()}))})),process.on("SIGINT",(function(){return e().then((function(){return process.exit()}))})),process.on("uncaughtException",(function(n){return e().then((function(){console.trace(n),process.exit(101)}))}))}:function(e){if("function"==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope){var n=self.close.bind(self);self.close=function(){return e(),n()}}else{if("function"!=typeof window.addEventListener)return;window.addEventListener("beforeunload",(function(){e()}),!0),window.addEventListener("unload",(function(){e()}),!0)}},R=new Set,W=!1;function F(){var e=[];return R.forEach((function(n){e.push(n()),R.delete(n)})),Promise.all(e)}function U(e,n){var t={context:"leader",action:n,token:e.token};return e.broadcastChannel.postInternal(t)}function q(e){e.isLeader=!0,e._hasLeader=!0;var n=function(e){if(W||(W=!0,J(F)),"function"!=typeof e)throw new Error("Listener is no function");return R.add(e),{remove:function(){return R.delete(e)},run:function(){return R.delete(e),e()}}}((function(){return e.die()}));e._unl.push(n);var t=function(n){"leader"===n.context&&"apply"===n.action&&U(e,"tell"),"leader"!==n.context||"tell"!==n.action||e._dpLC||(e._dpLC=!0,e._dpL(),U(e,"tell"))};return e.broadcastChannel.addEventListener("internal",t),e._lstns.push(t),U(e,"tell")}var G=function(e,n){var t=this;this.broadcastChannel=e,e._befC.push((function(){return t.die()})),this._options=n,this.isLeader=!1,this.isDead=!1,this.token=a(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+e.method.type+"||"+e.name};G.prototype={hasLeader:function(){var e=this;return navigator.locks.query().then((function(n){var t=n.held?n.held.filter((function(n){return n.name===e.lN})):[];return!!(t&&t.length>0)}))},awaitLeadership:function(){var e=this;if(!this._wLMP){this._wKMC.c=new AbortController;var n=new Promise((function(n,t){e._wKMC.res=n,e._wKMC.rej=t}));this._wLMP=new Promise((function(t){navigator.locks.request(e.lN,{signal:e._wKMC.c.signal},(function(){return e._wKMC.c=void 0,q(e),t(),n})).catch((function(){}))}))}return this._wLMP},set onduplicate(e){},die:function(){var e=this;return this._lstns.forEach((function(n){return e.broadcastChannel.removeEventListener("internal",n)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),U(this,"death")}};var z=function(e,n){var t=this;this.broadcastChannel=e,this._options=n,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=a(),this._aplQ=i,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(e){"leader"===e.context&&("death"===e.action&&(t._hasLeader=!1),"tell"===e.action&&(t._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};function V(e,n){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");n=function(e,n){return e||(e={}),(e=JSON.parse(JSON.stringify(e))).fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=n.method.averageResponseTime(n.options)),e}(n,e);var t="undefined"!=typeof navigator&&void 0!==navigator.locks&&"function"==typeof navigator.locks.request?new G(e,n):new z(e,n);return e._befC.push((function(){return t.die()})),e._leaderElector=t,t}z.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(e){var n=this;return this.isLeader?s(0,!0):this.isDead?s(0,!1):this._aplQC>1?this._aplQ:(this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then((function(){return function(){if(n.isLeader)return o;var t,r=!1,i=new Promise((function(e){t=function(){r=!0,e()}})),a=function(e){"leader"===e.context&&e.token!=n.token&&("apply"===e.action&&e.token>n.token&&t(),"tell"===e.action&&(t(),n._hasLeader=!0))};n.broadcastChannel.addEventListener("internal",a);var u=e?4*n._options.responseTime:n._options.responseTime;return U(n,"apply").then((function(){return Promise.race([s(u),i.then((function(){return Promise.reject(new Error)}))])})).then((function(){return U(n,"apply")})).then((function(){return Promise.race([s(u),i.then((function(){return Promise.reject(new Error)}))])})).catch((function(){})).then((function(){return n.broadcastChannel.removeEventListener("internal",a),!r&&q(n).then((function(){return!0}))}))}()})).then((function(){n._aplQC=n._aplQC-1})),this._aplQ.then((function(){return n.isLeader})))},awaitLeadership:function(){return this._aLP||(this._aLP=(e=this).isLeader?i:new Promise((function(n){var t=!1;function r(){t||(t=!0,e.broadcastChannel.removeEventListener("internal",o),n(!0))}e.applyOnce().then((function(){e.isLeader&&r()})),function n(){return s(e._options.fallbackInterval).then((function(){if(!e.isDead&&!t)return e.isLeader?void r():e.applyOnce(!0).then((function(){e.isLeader?r():n()}))}))}();var o=function(n){"leader"===n.context&&"death"===n.action&&(e._hasLeader=!1,e.applyOnce().then((function(){e.isLeader&&r()})))};e.broadcastChannel.addEventListener("internal",o),e._lstns.push(o)}))),this._aLP;var e},set onduplicate(e){this._dpL=e},die:function(){var e=this;return this._lstns.forEach((function(n){return e.broadcastChannel.removeEventListener("internal",n)})),this._lstns=[],this._unl.forEach((function(e){return e.remove()})),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,U(this,"death")}}}}]);
//# sourceMappingURL=747.61ca1ce8.js.map